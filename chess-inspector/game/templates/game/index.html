{% load static %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Chess Inspector</title>
  <link rel="icon" type="image/png" href="{% static 'favicon.ico' %}">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> -->
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
  <script src="{% static 'js/chessboard-1.0.0.js' %}" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{% static 'css/chessboard-1.0.0.css' %}" crossorigin="anonymous">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
  <script>
    $(document).ready(function() {
        function make_cover() {
            const cover = JSON.parse({{ coverage|safe }});
            for (const posn in cover) {
                const cell = cover[posn]
                let bkgd = 'gray';
                if (('is_protected_by' in cell) && (cell.is_protected_by.length > 0) && ('is_threatened_by' in cell) && (cell.is_threatened_by.length > 0)) {
                    bkgd = 'repeating-linear-gradient(45deg, lightgreen, lightgreen 10px, yellow 10px, yellow 20px)';
                } else if (('is_threatened_by' in cell) && (cell.is_threatened_by.length > 0)) {
                    bkgd = 'yellow';
                } else if (('is_protected_by' in cell) && (cell.is_protected_by.length > 0)) {
                    bkgd = 'lightgreen';
                } else if (('black_can_move_here' in cell) && (cell['black_can_move_here'].length > 0) && ('white_can_move_here' in cell) && (cell['white_can_move_here'].length > 0)) {
                    bkgd = 'repeating-linear-gradient(45deg, lightblue, lightblue 10px, tan 10px, tan 20px)';
                } else if (('black_can_move_here' in cell) && (cell['black_can_move_here'].length > 0)) {
                    bkgd = 'tan';
                } else if (('white_can_move_here' in cell) && (cell['white_can_move_here'].length > 0)) {
                    bkgd = 'lightblue';
                }
                elem = $('*[data-square="' + posn + '"]');
                elem.css('background', bkgd);
            }
        }

        function onDrop (source, target, piece, newPos, oldPos, orientation) {
            console.log(piece + ': ' + source + ' => ' + target);
            // console.log(Chessboard.objToFen(newPos));
            const payload = {
                fen: Chessboard.objToFen(newPos),
                csrfmiddlewaretoken: "{{ csrf_token }}",
            };
            $.post("{% url 'game:index' %}", payload, (data, status) => {
                $('body').html(data);
            });
        }
        var config = {
            draggable: true,
            position: "{{ fen|safe }}",
            dropOffBoard: 'trash',
            onDrop: onDrop,
        };
        var board = Chessboard('myBoard', config);

        $('.cover').click(function() {
            make_cover();
        });
    });
  </script>
</head>
<body>

<div class="container" id="container">
    <p></p>

{% if messages %}
    {% for message in messages %}
        <h2 style="color: green;">{{ message }}</h2>
    {% endfor %}
{% endif %}

    <div id="myBoard" style="width: 400px"></div>
    <p></p>
    <button type="button" class="btn btn-secondary cover">Cover</button>
    <a href="{% url 'game:index' %}" class="btn btn-secondary cover">Standard</a>
    <form action="{% url 'game:index' %}" method="post" style="display: inline-block;">
        {% csrf_token %}
        <input type="hidden" name="fen" value="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR">
        <button type="submit" class="btn btn-secondary" title="Restart">Restart</button>
    </form>
    <p></p>
    <form action="{% url 'logout' %}" method="post" class="form-horizontal">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary" id="logout" title="Logout">Logout</button>
    </form>

    <p></p>
</div>

</body>
</html>
