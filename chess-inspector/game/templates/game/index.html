{% load static %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Chess Inspector</title>
  <link rel="icon" type="image/png" href="{% static 'favicon.ico' %}">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> -->
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
  <script src="{% static 'js/chessboard-1.0.0.js' %}" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{% static 'css/chessboard-1.0.0.css' %}" crossorigin="anonymous">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
  <script>
        function make_cover() {
            const cover = JSON.parse({{ coverage|safe }});
            for (const posn in cover) {
                const cell = cover[posn]
                let bkgd = 'gray';
                if (('is_protected_by' in cell) && (cell.is_protected_by.length > 0) && ('is_threatened_by' in cell) && (cell.is_threatened_by.length > 0)) {
                    bkgd = 'repeating-linear-gradient(45deg, lightgreen, lightgreen 10px, yellow 10px, yellow 20px)';
                } else if (('is_threatened_by' in cell) && (cell.is_threatened_by.length > 0)) {
                    bkgd = 'yellow';
                } else if (('is_protected_by' in cell) && (cell.is_protected_by.length > 0)) {
                    bkgd = 'lightgreen';
                } else if (('black_can_move_here' in cell) && (cell['black_can_move_here'].length > 0) && ('white_can_move_here' in cell) && (cell['white_can_move_here'].length > 0)) {
                    bkgd = 'repeating-linear-gradient(45deg, lightblue, lightblue 10px, tan 10px, tan 20px)';
                } else if (('black_can_move_here' in cell) && (cell['black_can_move_here'].length > 0)) {
                    bkgd = 'tan';
                } else if (('white_can_move_here' in cell) && (cell['white_can_move_here'].length > 0)) {
                    bkgd = 'lightblue';
                }
                elem = $('*[data-square="' + posn + '"]');
                elem.css('background', bkgd);
            }
        }

        $(document).ready(function() {
            function gamePost(is_cover, lastPos, newPos) {
                const payload = {
                    play_n: play_n,
                    is_cover: is_cover,
                    en_passant: true, // TODO make this a page control
                    fen: newPos,
                    last_fen: lastPos,
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                };
                $.post("{% url 'game:index' %}", payload, (data, status) => {
                    $('body').html(data);
                });
            }
            function onDrop (source, target, piece, newPos, oldPos, orientation) {
                console.log(piece + ': ' + source + ' => ' + target);
                // console.log(Chessboard.objToFen(newPos));
                const payload = {
                    play_n: play_n,
                    is_cover: is_cover,
                    en_passant: true, // TODO make this a page control
                    fen: Chessboard.objToFen(newPos),
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                };
                $.post("{% url 'game:index' %}", payload, (data, status) => {
                    $('body').html(data);
                });
            }
            const config = {
                draggable: true,
                moveSpeed: 'slow',
                position: "{{ last_fen|safe }}",
                dropOffBoard: 'trash',
                onDrop: onDrop,
            };
            let board = Chessboard('myBoard', config);
            let last_fen = "{{ last_fen|safe }}";
            let is_cover = "{{ is_cover }}";
            if (is_cover.toLowerCase() == 'true') {
                make_cover();
            }
            const getCookieValue = (name) => (
                document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)')?.pop() || ''
            );
            const deleteCookie = (name) => {
                document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            };
            let data = []
            const fens = getCookieValue('fens');
            if (fens) {
                let string = fens.replace(/\\054/g, ',');
                string = string.replace(/\\/g, "");
                string = string.replace(/^"/, "");
                string = string.replace(/"$/, "");
                data = JSON.parse(string);
            }
            let play_n = {{ play_n }} || 0;
            let pgn_file = "{{ pgn_file }}";
            if ((typeof pgn_file == 'undefined') || (pgn_file == "")) {
                $('#play_forward').prop('disabled', true);
                $('#play_backward').prop('disabled', true);
                $('#clear_pgn').prop('disabled', true);
            }
            $('#play_forward').click(function() {
                if (typeof pgn_file !== 'undefined') {
                    play_n = play_n + 1;
                    gamePost(is_cover, data[play_n - 1], data[play_n]);
                }
            });
            $('#play_backward').click(function() {
                if (typeof pgn_file !== 'undefined' && play_n > 0) {
                    play_n = play_n - 1;
                    gamePost(is_cover, data[play_n - 1], data[play_n]);
                }
            });
            $('.cover').click(function() {
                is_cover = true;
                make_cover();
            });
            board.position("{{ fen|safe }}");
        });
</script>
</head>
<body>

<div class="container" id="container">
    <p></p>

{% if messages %}
    {% for message in messages %}
        <h2 style="color: green;">{{ message }}</h2>
    {% endfor %}
{% endif %}

    <h2>Chessboard Visualization</h2>
    <div id="myBoard" style="width: 400px"></div>
    <p></p>
    <button type="button" class="btn btn-sm btn-success cover">Coverage</button>
    <a href="{% url 'game:index' %}" class="btn btn-sm btn-success" onclick="location.href=this.href+'?play_n={{ play_n }}&is_cover=false&en_passant=true&fen={{ fen|safe }}&last_fen={{ last_fen|safe }}';return false;">Standard</a>
    <form action="{% url 'game:index' %}" method="post" style="display: inline-block;">
        {% csrf_token %}
        <input type="hidden" name="fen" value="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR">
        <button type="submit" class="btn btn-sm btn-primary" title="Restart">⏮︎</button>
        <button type="button" class="btn btn-sm btn-primary" id="play_backward" title="Play backward">⏴︎</button>
        <button type="button" class="btn btn-sm btn-primary" id="play_forward" title="Play forward">⏵︎</button>
    </form>
    <form action="{% url 'game:clear' %}" method="post" style="display: inline-block;">
        {% csrf_token %}
        <input type="hidden" name="fen" value="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR">
        <button type="submit" class="btn btn-sm btn-secondary" id="clear_pgn" title="Clear">Clear</button>
    </form>
    <p></p>
{% if pgn_file %}
    <div class="text-muted small pgn_file">Selected game: {{ pgn_file }}</div>
    <p></p>
{% endif %}
    <form action="{% url 'game:pgn' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="is_cover" value="{{ is_cover }}">
        <input type="hidden" name="en_passant" value="true">
        <input type="file" class="form-control" id="pgn" name="pgn" accept=".pgn" required>
        <button type="submit" class="btn btn-sm btn-secondary" title="Upload a PGN game">Upload PGN</button>
    </form>
    <p></p>
    <form action="{% url 'logout' %}" method="post" class="form-horizontal">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-dark" id="logout" title="Logout">Logout</button>
    </form>
    <p></p>
    <div id="footer" class="text-muted small">
      <hr>
      Built by <a href="http://gene.ology.net/">Gene</a>
      with <a href="https://www.djangoproject.com/">Django</a>,
      <a href="https://pypi.org/project/chess/">Chess</a>/<a href="https://pypi.org/project/chess-coverage/">Coverage</a>,
      <a href="https://chessboardjs.com/index.html">Chessboard</a>
    </div>
    <p></p>
</div>

</body>
</html>
